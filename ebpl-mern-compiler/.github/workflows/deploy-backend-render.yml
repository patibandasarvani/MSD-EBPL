name: Deploy backend to Render and update LINKS

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  deploy-and-update:
    runs-on: ubuntu-latest
    name: Trigger Render deploy and update LINKS.md
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Trigger Render deploy and wait
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          set -e
          echo "Triggering Render deploy for service: ${RENDER_SERVICE_ID}"
          DEPLOY_RESP=$(curl -s -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" -H "Authorization: Bearer ${RENDER_API_KEY}" -H "Content-Type: application/json" -d '{}')
          echo "Deploy response: $DEPLOY_RESP"
          echo "$DEPLOY_RESP" > deploy_resp.json
          DEPLOY_ID=$(jq -r '.id // .deployId // empty' deploy_resp.json)
          if [ -z "$DEPLOY_ID" ]; then
            echo "Failed to trigger deploy. Full response:"; cat deploy_resp.json; exit 1
          fi
          echo "Deploy id: $DEPLOY_ID"

          # Poll deploy status (timeout ~5min)
          for i in {1..30}; do
            STATUS=$(curl -s -H "Authorization: Bearer ${RENDER_API_KEY}" "https://api.render.com/v1/deploys/${DEPLOY_ID}" | jq -r '.state // .status // empty')
            echo "Attempt $i: deploy status=$STATUS"
            if [ "$STATUS" = "success" ] || [ "$STATUS" = "succeeded" ]; then
              echo "Deploy succeeded"
              break
            fi
            if [ "$STATUS" = "failed" ]; then
              echo "Deploy failed"; exit 1
            fi
            sleep 10
          done

          # Fetch service info to get the service URL
          SERVICE_INFO=$(curl -s -H "Authorization: Bearer ${RENDER_API_KEY}" "https://api.render.com/v1/services/${RENDER_SERVICE_ID}")
          echo "$SERVICE_INFO" > service_info.json

          # Try common fields for service URL (best-effort)
          RENDER_URL=$(jq -r '.serviceDetails.externalUrl // .serviceDetails.defaultDomain // .defaultDomain // .url // .externalUrl // empty' service_info.json | head -n1)
          if [ -z "$RENDER_URL" ]; then
            echo "Could not extract Render URL from API response. Dumping service_info.json for inspection."
            RENDER_URL="RENDER_SERVICE_URL_NOT_FOUND"
          fi

          echo "Render service URL: $RENDER_URL"
          echo "FRONTEND_URL=https://patibandasarvani.github.io/EBPL-final-project" > deploy_urls.env
          echo "BACKEND_URL=${RENDER_URL}" >> deploy_urls.env

      - name: Update LINKS.md and README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          source deploy_urls.env
          # Update LINKS.md
          echo "# Live Links" > LINKS.md
          echo >> LINKS.md
          echo "- Frontend (GitHub Pages): ${FRONTEND_URL}" >> LINKS.md
          echo "- Backend (Render): ${BACKEND_URL}" >> LINKS.md
          
          # Create/update README.md with project info and links
          if [ ! -f README.md ]; then
            echo "# EBPL Compiler" > README.md
            echo >> README.md
            echo "EBPL (Extendable Business Process Language) Compiler with React frontend and Express backend." >> README.md
            echo >> README.md
          fi
          
          # Add or update the links section in README
          if grep -q "^## Live Links" README.md; then
            # Links section exists - replace it and everything after until next ## or EOF
            sed -i '/^## Live Links/,/^## \|$/c\## Live Links\n\n- Frontend (GitHub Pages): '"${FRONTEND_URL}"'\n- Backend (Render): '"${BACKEND_URL}"'\n' README.md
          else
            # No links section - append it
            echo >> README.md
            echo "## Live Links" >> README.md
            echo >> README.md
            echo "- Frontend (GitHub Pages): ${FRONTEND_URL}" >> README.md
            echo "- Backend (Render): ${BACKEND_URL}" >> README.md
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add LINKS.md README.md
          git commit -m "docs: update LINKS.md and README.md with deployed URLs" || echo "No changes to commit"
          git push origin HEAD:main || echo "Push failed (maybe no permission)"
