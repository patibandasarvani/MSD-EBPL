name: Deploy backend to Render and update LINKS

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  deploy-and-update:
    runs-on: ubuntu-latest
    name: Trigger Render deploy and update LINKS.md
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Trigger Render deploy and wait
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          set -e
          echo "Triggering Render deploy for service: ${RENDER_SERVICE_ID}"
          DEPLOY_RESP=$(curl -s -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" -H "Authorization: Bearer ${RENDER_API_KEY}" -H "Content-Type: application/json" -d '{}')
          echo "Deploy response: $DEPLOY_RESP"
          echo "$DEPLOY_RESP" > deploy_resp.json
          DEPLOY_ID=$(jq -r '.id // .deployId // empty' deploy_resp.json)
          if [ -z "$DEPLOY_ID" ]; then
            echo "Failed to trigger deploy. Full response:"; cat deploy_resp.json; exit 1
          fi
          echo "Deploy id: $DEPLOY_ID"

          # Poll deploy status (timeout ~5min)
          for i in {1..30}; do
            STATUS=$(curl -s -H "Authorization: Bearer ${RENDER_API_KEY}" "https://api.render.com/v1/deploys/${DEPLOY_ID}" | jq -r '.state // .status // empty')
            echo "Attempt $i: deploy status=$STATUS"
            if [ "$STATUS" = "success" ] || [ "$STATUS" = "succeeded" ]; then
              echo "Deploy succeeded"
              break
            fi
            if [ "$STATUS" = "failed" ]; then
              echo "Deploy failed"; exit 1
            fi
            sleep 10
          done

          # Fetch service info to get the service URL
          SERVICE_INFO=$(curl -s -H "Authorization: Bearer ${RENDER_API_KEY}" "https://api.render.com/v1/services/${RENDER_SERVICE_ID}")
          echo "$SERVICE_INFO" > service_info.json

          # Try common fields for service URL (best-effort)
          RENDER_URL=$(jq -r '.serviceDetails.externalUrl // .serviceDetails.defaultDomain // .defaultDomain // .url // .externalUrl // empty' service_info.json | head -n1)
          if [ -z "$RENDER_URL" ]; then
            echo "Could not extract Render URL from API response. Dumping service_info.json for inspection."
            RENDER_URL="RENDER_SERVICE_URL_NOT_FOUND"
          fi

          echo "Render service URL: $RENDER_URL"
          echo "FRONTEND_URL=https://patibandasarvani.github.io/EBPL-final-project" > deploy_urls.env
          echo "BACKEND_URL=${RENDER_URL}" >> deploy_urls.env

      - name: Update LINKS.md and README.md, then push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          source deploy_urls.env
          
          # Update LINKS.md
          echo "# Live Links" > LINKS.md
          echo >> LINKS.md
          echo "- Frontend (GitHub Pages): ${FRONTEND_URL}" >> LINKS.md
          echo "- Backend (Render): ${BACKEND_URL}" >> LINKS.md
          
          # Update README.md (preserve everything except links section)
          awk -v frontend="${FRONTEND_URL}" -v backend="${BACKEND_URL}" '
          BEGIN { p=1 }
          /^## Live Links/ { 
            print $0
            print ""
            print "- Frontend (GitHub Pages):", frontend
            print "- Backend (Render):", backend
            print ""
            p=0
          }
          /^## / && !/^## Live Links/ { p=1 }
          p==1 { print $0 }
          ' README.md > README.md.new
          mv README.md.new README.md

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add LINKS.md README.md
          git commit -m "chore(ci): update LINKS.md and README.md with deployed URLs" || echo "No changes to commit"
          git push origin HEAD:main || echo "Push failed (maybe no permission)"
